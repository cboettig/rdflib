---
title: "Working with Database Storage Backends in `rdflib`"
author: "Carl Boettiger"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval=FALSE
)
```


By default, `rdflib` stores triples in memory, which can be read in from and written out to files on disk using a variety of serializations (`rdfxml`, `json-ld`, `ntriples`, `nquads` or `turtle`).  This is analgous to reading in a `data.frame` object from a `csv`, `tsv`, or other text-delimited file, which requires the full data object to be read into memory before a user can manipulate it.  This approach runs into limitations with very large datasets, which may exceed the memory available.  Just as R packages such as `dplyr` offer the ability to perform manipulations with very large data through a connection to a database backend such as SQLite, MySQL or PostgreSQL, `rdflib` can rely on these and other databases to provide a disk-based backend. 

### Installation

Unfortunately, at this time, support for these storage devices is not included in the prebuild Mac and Windows binaries of the `redland` R package.  Users wanting to take advantage of disk-based storage must instead build and install the `redland` R package from source; and in some cases, also build the `redland` C libraries from source.  This package provides a [Dockerfile](https://github.com/ropensci/rdflib/blob/master/inst/docker/Dockerfile) containing a portable recipe for building the library with support for the 5 main backend storage devices: SQLite, MySQL, PostgreSQL, Virtuoso, and Berkeley DB.  This vignette documents the installation and use of these devices.  

Also see the [official documentation](http://librdf.org/docs/api/redland-storage-modules.html) for the redland C library discussing all supported storage devices.  


## SQLite

[SQLite](https://en.wikipedia.org/wiki/SQLite) is probably the easiest disk-based storage option to deploy, requiring little or no extra setup.  

## Berkeley DB

The [Berkeley DB](https://en.wikipedia.org/wiki/Berkeley_DB) is a simple key-value store 

> It is the most mature and primary persistent store and suitable for large models, tested in the 2-3 million range.

Berkeley DB is a simple disk-based storage option.  Install both the redland libraries and the berkeley-db libraries, and then install `redland` from source.  


## Virtuoso

Unless you are already using it (because you already work with RDF data), a Virtuoso database is one of the more cumbersome to set up, but also quite probably one of the faster options.

## MySQL & Postgres

MySQL (or MariaDB) and Postgres backends 

# Benchmarks

```{r}
library(rdflib)
library(nycflights13)
```

```{r}
example <- flights[1:1e4,] # a subset for testing
write_nquads(example, "flights.nq", prefix = "flights")
```

## In Memory

```{r}
triplestore <- rdf()
system.time(
  read_nquads("flights.nq", rdf = triplestore)
)
```

```{r}
query <- 
  'SELECT  ?carrier ?flight ?origin ?dep_delay
WHERE {
?flight <x:carrier>  ?carrier .
?flight <x:dep_delay>  ?dep_delay .
?flight <x:origin> ?origin
}'

system.time(
df <- rdf_query(triplestore, query)
)
```

```{r}
rdf_free(triplestore)
```


## SQLite


```{r}
triplestore <- rdf(storage="sqlite", new_db = TRUE, name="rdflib.sqlite")

system.time(
  read_nquads("flights.nq", rdf = triplestore)
)
```


```{r}
system.time(
df <- rdf_query(triplestore, query)
)
```

```{r}
rdf_free(triplestore)
```

## POSTGRES

```{r}
triplestore <- rdf(storage = "postgres", 
                   host = "postgres", 
                   user = "postgres", 
                   password = "rdflib", 
                   new_db = TRUE)
system.time(
  read_nquads("flights.nq", rdf = triplestore)
)
```



```{r}
system.time(
df <- rdf_query(triplestore, query)
)
```

```{r}
rdf_free(triplestore)
```  

## MySQL

```{r}
triplestore <- rdf(storage = "mysql", 
                   host = "mariadb", 
                   user = "root", 
                   password = "rdflib", 
                   database = "mysql",
                   new_db = TRUE
                  )
system.time(
  read_nquads("flights.nq", rdf = triplestore)
)
  
```


```{r}
system.time(
df <- rdf_query(triplestore, query)
)
```

```{r}
rdf_free(triplestore)
```


## Virtuoso


```{r}
triplestore <- rdf(storage = "virtuoso", 
                   user = "dba", 
                   password = "dba", 
                   dsn = "Local Virtuoso", 
                   new_db = TRUE
                   )

system.time(
  read_nquads("flights.nq", rdf = triplestore)
)
```


```{r}
system.time(
df <- rdf_query(triplestore, query)
)
```


```{r}
rdf_free(triplestore)
```

## BDB


```{r}
triplestore <- rdf(storage="BDB", new_db = TRUE)
system.time(
  read_nquads("flights.nq", rdf = triplestore)
)
```


```{r}
system.time(
df <- rdf_query(triplestore, query)
)
```

```{r}
rdf_free(triplestore)
unlink("rdflib-po2s.db")
unlink("rdflib-so2p.db")
unlink("rdflib-sp2o.db")
```




# Testing

`rdflib` uses Circle-CI to test database backends using `docker-compose`.  `docker-compose` pulls down dedicated docker containers for `postgres` and `mariadb`, along with the `ropensci/rdflib` container, which includes a version of `redland` compiled with support for all five major backend storage systems.  At this time, testing is configured for:

- Berkeley DB
- SQLite
- Postgres
- MySQL (Using MariaDB)
- Virtuoso





The badge below (also on the package README) indicates that these dedicated tests are passing.

[![CircleCI](https://circleci.com/gh/ropensci/rdflib.svg?style=svg)](https://circleci.com/gh/ropensci/rdflib)
